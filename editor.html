<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <!--<link rel="stylesheet" href="css/bootstrap-theme.min.css">-->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/bootstrap-switch.min.css">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <!--<link rel="stylesheet" href="css/bootstrap-slider.css">-->
    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="js/jquery.touchSwipe.min.js"></script>
    <script src="js/bootstrap-switch.min.js"></script>
    <script src="js/bootbox.min.js"></script>
    <!--<script src="js/bootstrap-slider.js"></script>-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
<body data-spy="scroll" data-target=".scrollspy" data-color="">
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="loginModalLabel">Выход</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal">
          <div class="form-group">
            <label for="inputLoginModal" class="col-sm-2 control-label">Логин</label>
            <div class="col-sm-10">
              <input type="email" class="form-control" id="inputLoginModal" placeholder="Логин">
            </div>
          </div>
          <div class="form-group">
            <label for="inputPasswordModal" class="col-sm-2 control-label">Пароль</label>
            <div class="col-sm-10">
              <input type="password" class="form-control" id="inputPasswordModal" placeholder="Пароль">
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
              <div class="checkbox">
                <label>
                  <input type="checkbox"> Запомнить пароль
                </label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
              <button type="submit" class="btn btn-primary">Вход</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop" style="display:none"></div>
<nav class="navbar navbar-default navbar-top navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#"><img alt="RuRanobe" src="img/logo1.png"></a>
    </div>
    <div class="collapse navbar-collapse">
      <div class="secondLogoContainer"><div class="secondLogo"></div></div>
      <form class="navbar-form navbar-right">
            <button class="btn btn-white"> <b>Ник: </b>Kagge</button>
            <button class="btn btn-white"> <span class="glyphicon glyphicon-briefcase" aria-hidden="true"></span></button>
            <button class="btn btn-white"> <span class="glyphicon glyphicon-cog" aria-hidden="true"></span></button>
            <a class="btn btn-outline" data-toggle="modal" data-target="#loginModal">Выход</a>
      </form>
    </div>
  </div><!-- /.container -->
</nav>
<nav class="navbar navbar-default navbar-lower" role="navigation">
  <div class="container">
    <div class="collapse navbar-collapse collapse-buttons" id="bs-example-navbar-collapse-1">
      <form class="navbar-form visible-xs-block">
            <button class="btn btn-default">Регистрация</button>
            <a class="btn btn-primary" data-toggle="modal" data-target="#loginModal">Выход</a>
      </form>
      <ul class="nav navbar-nav">
            <li><a href="#">Обновления</a></li>
            <li><a href="#">Проекты</a></li>
            <li><a href="#">Набор в команду</a></li>
            <li><a href="#">FAQ</a></li>
            <li><a href="#">О нас</a></li>
            <li><a href="#">Связь</a></li>
      </ul>
      <form class="navbar-form navbar-right">
            <a href="#" class="btn btn-danger">Трансляции</a>
            <a href="https://vk.com/ru.ranobe" class="btn btn-primary"><i class="fa fa-vk"></i></a>
            <a href="#" class="btn btn-primary"><i class="fa fa-rss"></i></a>
      </form>
    </div>
  </div>
</nav>
<div class="container">
        <div class="leftColumn">
            <main class="content">
                <h2>Редактирование текста</h2>
                <div class="btn-toolbar edittext" role="toolbar" aria-label="Toolbar">
                    <div class="btn-group BoldItalian" role="group" aria-label="Жирный / Курсив / Подчеркнутый">
                        <button type="button" class="btn btn-default" title="Жирный" data-insert="'''insert'''"><i class="fa fa-bold"></i></button>
                        <button type="button" class="btn btn-default" title="Курсив"  data-insert="''insert''"><i class="fa fa-italic"></i></button>
                    </div>
                    <div class="btn-group Heading" role="group" aria-label="Заголовки">
                        <button type="button" class="btn btn-default" title="Заголовок 2-го уровня"  data-insert="==insert=="><i class="fa fa-header"></i>2</button>
                        <button type="button" class="btn btn-default" title="Заголовок 3-го уровня"  data-insert="===insert==="><i class="fa fa-header"></i>3</button>
                        <button type="button" class="btn btn-default UnderHead" title="Подзаголовок"  data-insert="{{Подзаголовок|insert}}"><i class="fa fa-header"></i><i class="fa fa-align-center" style="font-size:80%"></i></button>
                    </div>
                    <div class="btn-group Another" role="group" aria-label="Разное">
                        <button type="button" class="btn btn-default" title="Примечание"  data-insert="{{ref|insert}}"><i class="fa fa-file-text"></i></button>
                        <button type="button" class="btn btn-default" title="Комментарий"  data-insert="<!— insert —>"><i class="fa fa-tag"></i></button>
                        <button type="button" class="btn btn-default Illus" title="Иллюстрация" data-insert="{{Иллюстрация}}insert "><i class="fa fa-picture-o"></i></button>
                        <button type="button" class="btn btn-default" title="Ссылка на Википедию" data-insert="Подробнее на [insert Википедии]"><i class="fa fa-link"></i><span style="font-size: 72%; margin-left: -2px; vertical-align: super; font-weight: bold;">W</span></button>
                    </div>
                </div>
                <textarea class="form-control" id="textarea" name="textarea" cols="30" rows="50" style="min-height:400px;"></textarea>
            </main>
        </div>
        <aside class="right-sidebar">
            <div class="module" id="all-projects-module">
                <div class="module_name opened">
                    <i class="fa fa-chevron-down pull-left"></i>
                    <div class="h4">Проекты</div>
                </div>
                <div class="actions banners">
                    <a href="/r/sao" title="Sword Art Online"><img alt="Sword Art Online" src="http://ruranobe.ru/w/images/5/5a/sidebanner-sao.png" height="73" width="220"></a>
                    <a href="/r/mknr" title="Непутевый ученик в школе магии"><img alt="Непутевый ученик в школе магии" src="http://ruranobe.ru/w/images/2/2b/sidebanner-mknr.png" height="73" width="220"></a>
                    <a href="/r/drrr" title="Durarara!!"><img alt="Durarara!!" src="http://ruranobe.ru/w/images/6/6b/sidebanner-drrr.png" height="73" width="220"></a>
                    <a href="/r/aw" title="Accel World"><img alt="Accel World" src="http://ruranobe.ru/w/images/6/6b/sidebanner-aw.png" height="73" width="220"></a>
                    <a href="/r/ho" title="Heavy Object"><img alt="Heavy Object" src="http://ruranobe.ru/w/images/1/12/sidebanner-ho.png" height="73" width="220"></a>
                    <a href="/r/onc" title="Owari no Chronicle"><img alt="Owari no Chronicle" src="http://ruranobe.ru/w/images/2/22/sidebanner-onc.png" height="73" width="220"></a>
                    <a href="/r/hnc" title="Чайка − принцесса с гробом"><img alt="Чайка − принцесса с гробом" src="http://ruranobe.ru/w/images/e/e0/sidebanner-hnc.png" height="73" width="220"></a>
                    <a href="/r/mtikk" title="Проблемные дети приходят из другого мира, верно?"><img alt="Проблемные дети приходят из другого мира, верно?" src="http://ruranobe.ru/w/images/7/7d/sidebanner-mtikk.png" height="73" width="220"></a>
                    <a href="/r/ems" title="Эроманга-сэнсэй"><img alt="Эроманга-сэнсэй" src="http://ruranobe.ru/w/images/0/07/sidebanner-ems.png" height="73" width="220"></a>
                    <a href="/r/oregairu" title="Моя юношеская романтическая комедия оказалась неправильной, как я и предполагал"><img alt="Моя юношеская романтическая комедия оказалась неправильной, как я и предполагал" src="http://ruranobe.ru/w/images/6/64/sidebanner-oregairu.png" height="73" width="220"></a>
                    <a href="/r/trdr" title="ToraDora!"><img alt="ToraDora!" src="http://ruranobe.ru/w/images/1/15/sidebanner-trdr.png" height="73" width="220"></a>
                    <a href="/r/mnotv" title="Madan no Ou to Vanadis"><img alt="Madan no Ou to Vanadis" src="http://ruranobe.ru/w/images/b/b9/sidebanner-mnotv.png" height="73" width="220"></a>
                    <a href="/r/ssnts" title="Дуэлянт странствующей богини"><img alt="Дуэлянт странствующей богини" src="http://ruranobe.ru/w/images/1/12/sidebanner-ssnts.png" height="73" width="220"></a>
                    <a href="/r/lh" title="Log Horizon"><img alt="Log Horizon" src="http://ruranobe.ru/w/images/f/f5/sidebanner-lh.png" height="73" width="220"></a>
                    <a href="/r/mdn" title="Пусть твоя душа упокоится в Магдале"><img alt="Пусть твоя душа упокоится в Магдале" src="http://ruranobe.ru/w/images/3/30/sidebanner-mdn.png" height="73" width="220"></a>
                    <a href="/r/tnynn" title="Становление Героя Щита"><img alt="Становление Героя Щита" src="http://ruranobe.ru/w/images/1/19/sidebanner-tnynn.png" height="73" width="220"></a>
                    <a href="/r/snpnk" title="Кошечка из Сакурасо"><img alt="Кошечка из Сакурасо" src="http://ruranobe.ru/w/images/1/18/sidebanner-snpnk.png" height="73" width="220"></a>
                    <a href="/r/ol" title="Overlord"><img alt="Overlord" src="http://ruranobe.ru/w/images/a/a6/sidebanner-ol.png" height="73" width="220"></a>
                    <a href="/r/ngnl" title="No Game No Life"><img alt="No Game No Life" src="http://ruranobe.ru/w/images/4/42/sidebanner-ngnl.png" height="73" width="220"></a>
                    <a href="/r/tr" title="Tokyo Ravens"><img alt="Tokyo Ravens" src="http://ruranobe.ru/w/images/f/fb/sidebanner-tr.png" height="73" width="220"></a>
                    <a href="/r/tmni" title="Некий Магический Индекс"><img alt="Некий Магический Индекс" src="http://ruranobe.ru/w/images/8/88/sidebanner-tmni.png" height="73" width="220"></a>
                    <a href="/r/haruhi" title="Серия Харухи Судзумии"><img alt="Серия Харухи Судзумии" src="http://ruranobe.ru/w/images/4/4f/sidebanner-haruhi.png" height="73" width="220"></a>
                    <a href="/r/saw" title="Волчица и пряности"><img alt="Волчица и пряности" src="http://ruranobe.ru/w/images/9/9e/sidebanner-saw.png" height="73" width="220"></a>
                    <a href="/r/ch2b" title="Чудачества любви не помеха!"><img alt="Чудачества любви не помеха!" src="http://ruranobe.ru/w/images/1/1a/sidebanner-ch2b.png" height="73" width="220"></a>
                    <a href="/r/aynik" title="All You Need Is Kill"><img alt="All You Need Is Kill" src="http://ruranobe.ru/w/images/b/ba/sidebanner-aynik.png" height="73" width="220"></a>
                    <a href="/r/tnd" title="Наше путешествие на край исчезающего мира"><img alt="Наше путешествие на край исчезающего мира" src="http://ruranobe.ru/w/images/2/26/sidebanner-tnd.png" height="73" width="220"></a>
                    <a href="/r/sd" title="Sugar Dark"><img alt="Sugar Dark" src="http://ruranobe.ru/w/images/3/33/sidebanner-sd.png" height="73" width="220"></a>
                    <a href="/r/inkid" title="Безжизненный мир"><img alt="Безжизненный мир" src="http://ruranobe.ru/w/images/7/74/sidebanner-inkid.png" height="73" width="220"></a><a href="/r/ff7" title="Final Fantasy VII"><img alt="Final Fantasy VII" src="http://ruranobe.ru/w/images/4/42/sidebanner-ff7.png" height="73" width="220"></a>
                </div>
            </div>
            <div class="module">
                <div class="module_name opened">
                    <i class="fa fa-chevron-down pull-left"></i>
                    <div class="h4">Друзья</div>
                </div>
                <div class="actions banners">
                    <a href="#"><img src="img/friend.png"></a>
                </div>
            </div>
        </aside>
</div>
<div class="container">
    <footer>
        <div class="footer">
            <a href="#">Обновления</a>
            <a href="#">Проекты</a>
            <a href="#">Набор в команду</a>
            <a href="#">FAQ</a>
            <a href="#">О нас</a>
            <a href="#">Помощь</a>
            <a href="#">Связь</a>
        </div>
        <div class="copyright text-center">&copy; Проект <span class="bold">&laquo;РуРанобэ&raquo; </span>2015</div>
    </footer>
</div>
<div class="overlayT"></div>
<script src="js/ellipses-left.js"></script>
<script src="js/page.all.js"></script>
<script>/*
$.fn.getRange = function(start, end) {
    return this.each(function() {
        if (this.setSelectionRange) {
            this.focus();
            this.setSelectionRange(start, end);
        } else if (this.createTextRange) {
            var range = this.createTextRange();
            range.collapse(true);
            range.moveEnd('character', end);
            range.moveStart('character', start);
            range.select();
        }
    });
};*/
$.fn.getRange = function (start, end) {
    if (start && end) {
        return this.each(function () {
            if (this.setSelectionRange) {
                this.focus();
                this.setSelectionRange(start, end);
            } else if (this.createTextRange) {
                var range = this.createTextRange();
                range.collapse(true);
                range.moveEnd('character', end);
                range.moveStart('character', start);
                range.select();
            }
        });
    } else {
        return {
            'start': $(this)[0].selectionStart
            , 'end': $(this)[0].selectionEnd
            , 'sellength': $(this)[0].selectionEnd - $(this)[0].selectionStart
        }
    }
};
$.fn.insertData = function () {
    return $(this).data('insert').split('insert');
}
$.fn.getLine = function (line) {
    return $(this).val().split("\n")[line];
}
var textarea = $('#textarea');

function find(array, value) {
    for (var i = 0; i < array.length; i++) {
        if (array[i] == value) return i;
    }
    return -1;
}

function clear(text, extra) {
    var status = []; // 0 - ничего, 1 - курсив, 2 - жирный, 3 - заголовок2, 4 - заголовок 3, 5 - подзаголовок
    var statusL = 0;
    var statuses = [];
    var array = ["\'\'\'", "\'\'", "\=\=\=", "\=\=", "\{\{Подзаголовок"];
    var extra = extra ? true : false;
    for (var i = 0; i < array.length; i++) {
        if (i != 4) {
            found = text.match(array[i] + "[0-9a-zA-Zа-яА-Я]+" + array[i]);
        } else {
            found = text.match("\{\{Подзаголовок\|" + "[0-9a-zA-Zа-яА-Я]+" + "\}\}");
        }
        if (found != null) {
            status.push(i);
            statusL++;
            statuses.push(array[i]);
        }
    }
    if (status.length != 0) {
        for (var i = 0; i < statuses.length; i++) {
            if (((find(status, 0) != -1) || (find(status, 1) != -1)) && extra) {
                return {
                    'text': text
                    , 'left': 0
                    , 'right': 0
                };
            }
            if (find(status, 4) == -1) {
                search1L = search2L = statuses[i].length;
            } else {
                search1L = statuses[i].length + 1;
                search2L = 2;
            }
            text = (text.substr(search1L)).slice(0, -search2L);
            return {
                'text': text
                , 'left': 240
                , 'right': 0
            };
        }
    } else {
        return {
            'text': text
            , 'left': 0
            , 'right': 0
        };
    }
}


/*
    for(var i=0; i<array.length; i++) {
        found = text.match(array[i]);
        if(found != -1){
            status = i+1;
            statusL++;
            statuses[i] = array[i];
        }
    }
      console.log(statusL);
      console.log('[qwe')
      console.log(status);
    if(status != 0){
      var found1st, lengthStatus1, left, right, lengthStatus2;
      console.log(statusL);

      for(var i = 0; i < statusL; i++){
        if((status == 1 || status == 2) && extra){
          return {'text':text,'left':0,'right':0};
        }
        console.log(statuses[i] + 'statuses');
        if(status != 5){
            search1 = search2 = status[i];
        } else {
            search1 = status[i];
            search2 = '}}';
        }
        founded = text.match(search1+"[a-zA-Zа-яА-Я]+"+search2);
        console.log(search1+"text+"+search2+"founded"+founded);
        console.log('[qwe')
        return {'text':founded,'left':240, 'right':0};
      }
    } else {
        return {'text':text,'left':0,'right':0};
    }
  }*/
function actOnEachLine(textarea, func) {
    var lines = textarea.val().replace(/\r\n/g, "\n").split("\n");
    var newLines, newValue, i;

    if (typeof lines.map != "undefined") {
        newLines = lines.map(func);
    } else {
        newLines = [];
        i = lines.length;
        while (i--) {
            newLines[i] = func(lines[i]);
        }
    }
    textarea.val() = newLines.join("\r\n");
}

function allline(text, line, buttons) {
    var scrollPos = textarea.scrollTop;
    var sel = textarea.getRange();

    var lines = textarea.val().replace(/\r\n/g, "\n").split("\n");
    var newLines, newValue, lengthLine, textL;

    newLines = [];
    lengthLine = lines.length;
    for (var i = 0; i < lengthLine; i++) {
        if (i == line) {
            if (text[0] == "{{Подзаголовок|") {
                lines[i] = clear(lines[i], 777).text;
            } else {
                lines[i] = clear(lines[i]).text;
            }
            lines[i] = text[0] + lines[i] + text[1];
            textL = lines[i].length;
        }
        newLines[i] = lines[i];
    };
    var insert = {
        'left': text[0].length
        , 'right': text[1].length
    };
    textarea.val(newLines.join("\r\n"));
    if (line == textarea.val().split("\n").length - 1) {
        textarea.val(textarea.val() + "\n");
    }
    position(sel, textL, 0, insert, line);
    textarea.scrollTop = scrollPos;
}

function insertAtCaret(text, type, buttons) {
    var sel = textarea.getRange();
    var scrollPos = textarea.scrollTop;
    var strPos = 0;
    strPos = sel.start;
    strPosEnd = sel.end;
    var front = (textarea.val()).substring(0, strPos);
    var center = (textarea.val()).substring(strPos, strPosEnd);
    var back = (textarea.val()).substring(strPosEnd, textarea.val().length);
    if (type == 1) {
        if (text[0] == "{{Подзаголовок|") {
            center = clear(center, 777).text;
        } else {
            center = clear(center).text
        }
        center = "\n" + text[0] + center + text[1] + "\n";
    } else if (type == 2) {
        center = text[0] + '' + text[1];
    } else {
        center = text[0] + center + text[1];
    }
    textL = center.length;
    var insert = {
        'left': text[0].length
        , 'right': text[1].length
    };
    textarea.val(front + center + back);
    position(sel, textL, type, insert);
    textarea.scrollTop = scrollPos;
}
function TEKCTline(line){
    var lines = textarea.val().replace(/\r\n/g, "\n").split("\n");
    newLines = [];
    lengthLine = lines.length;
    for (var i = 0; i < lengthLine; i++) {
        if (i == line) {
           lines[i] = "TEKCT";
        }
        newLines[i] = lines[i];
    };
    textarea.val(newLines.join("\r\n"));
}
function position(sel, textL, type, insert, line) {
    var add = (type == 1) ? 1 : 0;
    var s;
    var text = textL - insert.left - insert.right;
    if (text === 0) {
        var sl = sel.start + insert.left;
        textarea.getRange(sl,sl);
    } else {
        if (sel.sellength === 0) {
            if (textarea.val().indexOf(textarea.getLine(line + 1)) - 1 < (sel.start + textL)) {
                s = textarea.val().indexOf(textarea.getLine(line + 1)) - 1;
                textarea.getRange(s, s);
            } else {
                s = sel.start + textL;
                textarea.getRange(s, s);
            }
        } else {
            s = sel.end + insert.left + insert.right + add;
            textarea.getRange(s, s);
        };
    }
    textarea.focus();
}
$('.edittext .BoldItalian button').click(function (e) {
    var input = $(this).insertData();
    var sel = textarea.getRange();
    var line = textarea.val().substr(0, sel.start).split("\n").length - 1;
    if ((e.shiftKey)&&(e.ctrlKey)){
        TEKCTline(line)
        allline(input, line);
        textarea.getRange(textarea.val().indexOf("TEKCT"),textarea.val().indexOf("TEKCT")+5)
    } else if (e.shiftKey) {
        allline(input, line);
    } else if (e.ctrlKey){
        textarea[0].setRangeText('TEKCT');
        textarea.getRange(sel.start,sel.start+5);
        insertAtCaret(input);
        textarea.getRange(sel.start+input[0].length,sel.start+input[0].length+5)
    } else {
        insertAtCaret(input);
    }
})
$('.edittext .Another button').click(function (e) {
    var input = $(this).insertData();
    console.log(input);
    if ($(this).hasClass('Illus')) {
        var sel = textarea.getRange();
        var line = textarea.val().substr(0, sel.start).split("\n").length - 1;
        if (e.shiftKey) {
            allline(input, line);
        } else {
            if (sel.sellength == 0) {
                if (textarea.val().indexOf(textarea.getLine(line + 1)) - 1 == getText().end) {
                    if (textarea.getLine(line) == "") {
                        allline(input, line);
                    } else {
                        input[0] = "\n" + input[0];
                        input[1] = input[1] + "\n";
                        insertAtCaret(input, 2);
                    }
                } else {
                    input[0] = "\n" + input[0];
                    insertAtCaret(input, line);
                }
            } else {
                input[0] = "\n" + input[0];
                insertAtCaret(input, 2);
            }
        }
    } else {
        insertAtCaret(input);
    }
})


$('.edittext .Heading button').click(function (e) {
    var input = $(this).insertData();
    var sel = textarea.getRange();
    console.log(sel);
    var line = textarea.val().substr(0, sel.start).split("\n").length - 1;
    if (sel.sellength == 0) {
        allline(input, line);
    } else {
        if (textarea.val().indexOf(textarea.getLine(line)) == sel.start && textarea.val().indexOf(textarea.getLine(1)) + textarea.getLine(1).length == sel.end) {
            console.log('allline');
            allline(input, line);
        } else {
            if ((e.shiftKey)&&(e.ctrlKey)){
                TEKCTline(line)
                allline(input, line);
                textarea.getRange(textarea.val().indexOf("TEKCT"),textarea.val().indexOf("TEKCT")+5)
            } else if (e.shiftKey) {
                allline(input, line);
            } else if (e.ctrlKey){
                textarea[0].setRangeText('TEKCT');
                textarea.getRange(sel.start,sel.start+5);
                insertAtCaret(input, 1);
                textarea.getRange(sel.start+input[0].length+1,sel.start+input[0].length+6)
            } else {
                insertAtCaret(input, 1);
            }
        }
    }
})





var ta = document.querySelector('textarea');
ta.addEventListener('keyup', function(e) {
    if (this.lastValue == null) {
        this.lastValue = this.defaultValue;
    }

    var last = this.lastValue,
        current = this.value;

    var ta = this;

    var methods = {};
    methods.overText = function(start, end, text) {
        ta.selectionStart = start;
        ta.selectionEnd = end;
        document.execCommand('insertText', false, text);
    }
    methods.TextEvent = function(start, end, text) {
        var e = document.createEvent('TextEvent');
        e.initTextEvent('textInput', true, true, null, text, 9, "en-US");
        ta.focus();
        ta.setSelectionRange(start, end);
        ta.dispatchEvent(e);
    }
    methods.replaceValue = function(start, end, text) {
        var str =
            ta.value.substr(0, start) +
            text +
            ta.value.substr(end);
        ta.selectionStart = 0;
        ta.selectionEnd = ta.value.length;
        document.execCommand('insertText', false, str);
    }
    methods.setValue = function(start, end, text) {
        var str =
            ta.value.substr(0, start) +
            text +
            ta.value.substr(end);
        ta.value = str;
    }
    if (current.length > last.length) {
        var start = this.selectionStart,
            added = current.substr(start - 1, 1);
    }
    this.lastValue = this.value;
    });
    ta.focus();
    ta.selectionStart = ta.selectionEnd = ta.value.length;
</script>
</body>
</html>